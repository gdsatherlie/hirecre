import fs from "node:fs";
import path from "node:path";
import { createClient } from "@supabase/supabase-js";

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
  console.error("Missing Supabase env vars");
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

// --- CONFIG (tune these later) ---
const PICKS = 8;                // how many items in the weekly issue
const MIN_SCORE = 12;           // raise this if you still see “deal noise”
const LOOKBACK_DAYS = 7;        // weekly window
const OUTPUT_DIR = "newsletters";

// Simple date helpers (UTC)
function yyyyMmDd(d) {
  return d.toISOString().slice(0, 10);
}

function startOfTodayUTC() {
  const d = new Date();
  d.setUTCHours(0, 0, 0, 0);
  return d;
}

function daysAgoUTC(n) {
  const d = startOfTodayUTC();
  d.setUTCDate(d.getUTCDate() - n);
  return d;
}

function esc(s = "") {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;");
}

// Minimal HTML template (you can style later)
function renderHTML({ issueDate, title, items }) {
  const rows = items
    .map(
      (it, idx) => `
        <tr>
          <td style="padding:10px 0; border-bottom:1px solid #eee;">
            <div style="font:600 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial;">
              ${idx + 1}. ${esc(it.title)}
            </div>
            <div style="font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#666; margin-top:4px;">
              ${esc(it.source)} • ${esc(it.signal_type)} • score ${it.score}
            </div>
            <div style="margin-top:6px;">
              <a href="${esc(it.url)}" style="font:13px system-ui, -apple-system, Segoe UI, Roboto, Arial;">
                Read
              </a>
            </div>
          </td>
        </tr>
      `
    )
    .join("");

  return `<!doctype html>
<html>
  <body style="margin:0; background:#fafafa;">
    <div style="max-width:680px; margin:0 auto; background:#ffffff; padding:24px;">
      <div style="font:700 22px system-ui, -apple-system, Segoe UI, Roboto, Arial;">
        ${esc(title)}
      </div>
      <div style="font:13px system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#666; margin-top:6px;">
        Week of ${esc(issueDate)}
      </div>

      <div style="font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin-top:18px; color:#111;">
        Macro signals that actually matter — rates, distress, leasing trends, capital markets, and big positioning moves.
      </div>

      <table width="100%" cellpadding="0" cellspacing="0" style="margin-top:18px;">
        ${rows}
      </table>

      <div style="font:12px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#999; margin-top:18px;">
        Generated by HireCRE Market Signals.
      </div>
    </div>
  </body>
</html>`;
}

async function main() {
  const issueDate = yyyyMmDd(startOfTodayUTC());
  const since = daysAgoUTC(LOOKBACK_DAYS).toISOString();

  const title = `HireCRE — Weekly Macro Signals`;

  // 1) Pull top candidates
  const { data: signals, error: sigErr } = await supabase
    .from("market_signals")
    .select("id, title, source, signal_type, score, url, created_at, used_in_issue")
    .gte("created_at", since)
    .eq("used_in_issue", false)
    .gte("score", MIN_SCORE)
    .order("score", { ascending: false })
    .limit(PICKS);

  if (sigErr) throw sigErr;

  if (!signals || signals.length === 0) {
    console.log("No signals found for weekly issue (try lowering MIN_SCORE).");
    process.exit(0);
  }


  // 2) Create/Upsert the issue row (avoid schema-cache issues by only writing known columns)
const { data: issueRow, error: issueErr } = await supabase
  .from("newsletter_issues")
  .upsert(
    { issue_date: issueDate, title }, // <-- keep minimal
    { onConflict: "issue_date" }
  )
  .select("id")
  .single();

if (issueErr) throw issueErr;

const issueId = issueRow.id;

// (optional) best-effort timestamp update (won’t break if cache lags)
await supabase
  .from("newsletter_issues")
  .update({ generated_at: new Date().toISOString() })
  .eq("id", issueId);


  // 3) Insert issue items (positions)
  const itemsToInsert = signals.map((s, i) => ({
    issue_id: issueId,
    market_signal_id: s.id,
    position: i + 1,
  }));

  const { error: itemsErr } = await supabase
    .from("newsletter_issue_items")
    .upsert(itemsToInsert, { onConflict: "issue_id,market_signal_id" });

  if (itemsErr) throw itemsErr;

  // 4) Generate HTML preview file (DRY RUN output)
  const html = renderHTML({
    issueDate,
    title,
    items: signals.map((s) => ({
      title: s.title,
      source: s.source,
      signal_type: s.signal_type,
      score: s.score,
      url: s.url,
    })),
  });

  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
  const outPath = path.join(OUTPUT_DIR, `weekly-macro-${issueDate}.html`);
  fs.writeFileSync(outPath, html, "utf8");

  console.log(`✅ Built weekly issue preview: ${outPath}`);
  console.log(`Issue ID: ${issueId}`);
  console.log(`Items: ${signals.length}`);

  console.log("\nNEXT STEP:");
  console.log("If the preview looks good, we will 'freeze' these picks by marking used_in_issue=true.");
  console.log("That becomes Step 4 (finalize).");
}

main().catch((e) => {
  console.error("❌ build-weekly-market-newsletter failed:", e);
  process.exit(1);
});
